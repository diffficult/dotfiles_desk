#!/bin/bash

SESSION_TYPE="${XDG_SESSION_TYPE:-}"
if [[ -z "$SESSION_TYPE" && -n "$WAYLAND_DISPLAY" ]]; then
    SESSION_TYPE="wayland"
fi
if [[ -z "$SESSION_TYPE" ]]; then
    SESSION_TYPE="x11"
fi

if [[ "$SESSION_TYPE" == "wayland" ]]; then
    VIDURL=$(wl-paste)
else
    VIDURL=$(xclip -o)
fi

# Function to run a command in a new st instance
run_st() {
    st -T "1080p stream" -e zsh -c "$* ; read -p 'Press Enter to close...'" &
    sleep 0.1
    if [[ "$SESSION_TYPE" == "wayland" ]]; then
        if command -v swaymsg >/dev/null 2>&1; then
            swaymsg '[title="1080p stream"] move scratchpad' >/dev/null 2>&1
        fi
    else
        xdotool search --sync --name "1080p stream" windowminimize %@
    fi
}
notify-send -t 3500 'Streaming @ 1080p' --icon="/usr/share/icons/Nordzy/apps/scalable/youtube.svg"
## ORIGINAL 1080p res
#mpv $VIDURL --ytdl --ytdl-format=137+bestaudio/270+bestaudio/136+bestaudio/232+bestaudio/best --volume=50
run_st "mpv '$VIDURL' --ytdl --ytdl-format='bestvideo[height=1080]+bestaudio/bestvideo[height<=1080]+bestaudio/best' --ytdl-raw-options=cookies=cookies.txt --volume=75 --no-resume-playback"

#--no-terminal 2&>1 1>/dev/null

#mpv $VIDURL --ytdl --ytdl-format="bestvideo[height>=1080]+bestaudio/best" --volume=50
#mpv $VIDURL --ytdl --ytdl-format="bestvideo[height=1080][fps>=?30][vcodec!=?vp9]+bestaudio/best[height=1080]" --volume=50


## uncomment to get 720p video dash or 480p if not available
#mpv $1 --ytdl --ytdl-format=136+bestaudio/247+bestaudio/22/135+bestaudio/18/best --volume=50
